{% extends "base.html" %}

{% block title %}Orders - PharmaCare{% endblock %}

{% block content %}
<div class="container-fluid px-4 px-md-5 py-4 min-vh-100">

  <!-- HEADER -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div>
          <h1 class="fw-bold mb-1 text-primary">
            <i class="bi bi-receipt-cutoff me-2"></i>Orders Management
          </h1>
          <p class="text-muted mb-0 fs-6">
            View and manage your orders based on your role
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- CARD -->
  <div class="card shadow-sm border-0 rounded-3">

    <!-- CARD HEADER -->
    <div class="card-header bg-light border-0 py-3">
      <h5 class="mb-0 fw-semibold">
        <i class="bi bi-list-ul me-2 text-primary"></i>Order List
      </h5>
    </div>

    <!-- FILTERS -->
    <form method="get" class="row g-3 p-3 border-bottom bg-light">
      <div class="col-md-3">
        <input type="text" name="order_number"
               value="{{ request.GET.order_number }}"
               class="form-control"
               placeholder="Order Number">
      </div>

      <div class="col-md-2">
        <select name="status" class="form-select">
          <option value="">Order Status</option>
          <option value="pending" {% if request.GET.status == "pending" %}selected{% endif %}>Pending</option>
          <option value="processing" {% if request.GET.status == "processing" %}selected{% endif %}>Processing</option>
          <option value="completed" {% if request.GET.status == "completed" %}selected{% endif %}>Completed</option>
          <option value="cancelled" {% if request.GET.status == "cancelled" %}selected{% endif %}>Cancelled</option>
        </select>
      </div>

      <div class="col-md-2">
        <select name="payment_status" class="form-select">
          <option value="">Payment Status</option>
          <option value="paid" {% if request.GET.payment_status == "paid" %}selected{% endif %}>Paid</option>
          <option value="pending" {% if request.GET.payment_status == "pending" %}selected{% endif %}>Pending</option>
          <option value="failed" {% if request.GET.payment_status == "failed" %}selected{% endif %}>Failed</option>
        </select>
      </div>

      <div class="col-md-2">
        <input type="date" name="from_date"
               value="{{ request.GET.from_date }}"
               class="form-control">
      </div>

      <div class="col-md-2">
        <input type="date" name="to_date"
               value="{{ request.GET.to_date }}"
               class="form-control">
      </div>

      <div class="col-md-1 d-grid">
        <button class="btn btn-primary">
          <i class="bi bi-funnel"></i>
        </button>
      </div>
    </form>

    <!-- TABLE -->
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>#</th>

              {% if user.role == "patient" %}
                <th>Pharmacy</th>
              {% elif user.role == "pharmacist" %}
                <th>Customer</th>
              {% else %}
                <th>Pharmacy</th>
              {% endif %}

              <th>Order Number</th>
              <th>Status</th>
              <th>Payment Status</th>
              <th>Total</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody>
            {% for order in orders %}
            <tr class="border-bottom">
              <td>{{ forloop.counter }}</td>

              <td>
                {% if user.role == "patient" %}
                  {{ order.pharmacy.pharmacy_name|default:order.pharmacy.username }}
                {% elif user.role == "pharmacist" %}
                  {{ order.patient.username }}
                {% else %}
                  {{ order.pharmacy.pharmacy_name|default:order.pharmacy.username }}
                {% endif %}
              </td>

              <td>{{ order.order_number }}</td>

              <td>
                <span class="badge rounded-pill px-3 py-2 fs-6
                  {% if order.status == 'completed' %}bg-success
                  {% elif order.status == 'processing' %}bg-info
                  {% elif order.status == 'pending' %}bg-warning text-dark
                  {% elif order.status == 'cancelled' %}bg-danger
                  {% else %}bg-secondary{% endif %}">
                  {{ order.status|title }}
                </span>
              </td>

              <td>
                <span class="badge rounded-pill px-3 py-2 fs-6
                  {% if order.payment_status == 'paid' %}bg-success
                  {% elif order.payment_status == 'pending' %}bg-warning text-dark
                  {% elif order.payment_status == 'failed' %}bg-danger
                  {% else %}bg-secondary{% endif %}">
                  {{ order.payment_status|title }}
                </span>
              </td>

              <td class="fw-bold">â‚¹{{ order.total_amount|floatformat:2 }}</td>

              <td>{{ order.created_at|date:"M d, Y H:i" }}</td>

              <td>
                <div class="btn-group">
                  <a href="{% url 'order_detail' order.id %}"
                     class="btn btn-outline-primary btn-sm rounded-pill px-3">
                    <i class="bi bi-eye me-1"></i>View
                  </a>

                  {% if user.role == "admin" or user.role == "pharmacist" %}
                  <a href="{% url 'update_order_status' order.id %}"
                     class="btn btn-outline-info btn-sm rounded-pill px-3">
                    <i class="bi bi-pencil me-1"></i>Update
                  </a>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8" class="text-center py-5 text-muted">
                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                No orders found
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- FOOTER -->
    {% if orders %}
    <div class="card-footer bg-light border-0 py-3">
      <small class="text-muted">
        Showing {{ orders|length }} order{{ orders|length|pluralize }}
      </small>
    </div>
    {% endif %}

  </div>
</div>

<style>
  .table-hover tbody tr:hover {
    background-color: rgba(13, 110, 253, 0.05);
  }
</style>
{% endblock %}
